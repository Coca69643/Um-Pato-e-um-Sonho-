<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Um Pato e um Sonho - Engine V1.2</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #222; font-family: sans-serif; }
        #ui-layer { position: fixed; inset: 0; pointer-events: none; z-index: 100; }
        #ui-layer * { pointer-events: auto; }
        .status-container { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; border: 2px solid #333; }
        .bar { width: 120px; height: 10px; background: #1a1a1a; margin: 4px 0; border-radius: 5px; overflow: hidden; }
        .fill { height: 100%; transition: width 0.3s; }
        #joystick-base { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #fff3; }
        #joystick-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.7; }
        #action-bar { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; }
        .btn-action { width: 65px; height: 65px; background: #333; border: 3px solid #111; border-radius: 12px; color: #fff; font-size: 10px; font-weight: bold; }
        canvas { display: block; image-rendering: pixelated; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="status-container">
            <div class="bar"><div id="hp-bar" class="fill" style="background: #ff4d4d; width: 100%;"></div></div>
            <div class="bar"><div id="hunger-bar" class="fill" style="background: #ffcc00; width: 100%;"></div></div>
        </div>
        <div id="joystick-base"><div id="joystick-stick"></div></div>
        <div id="action-bar"><button class="btn-action" onclick="game.interact()">⛏️<br>COLETAR</button></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        /** @type {HTMLCanvasElement} */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });

        const TILE_SIZE = 32;
        const PLAYER_SPEED = 160;

        const game = {
            lastTime: 0,
            width: 0,
            height: 0,
            player: {
                x: 1000, y: 1000,
                radius: 12, // Raio de colisão física
                hp: 100, hunger: 100,
                dir: 1
            },
            camera: { x: 0, y: 0 },
            world: { seed: 12345, density: 0.05 },
            input: { joyX: 0, joyY: 0, isTouching: false },
            interact() { console.log("Interação disparada"); }
        };

        // --- PHYSICS & WORLD GEN ---
        function seededRandom(x, y) {
            const seed = game.world.seed;
            const value = Math.sin(x * 12.9898 + y * 78.233 + seed) * 43758.5453;
            return value - Math.floor(value);
        }

        /** Verifica colisão em um ponto específico do mundo */
        function checkCollision(newX, newY) {
            const startX = Math.floor((newX - 50) / TILE_SIZE);
            const endX = Math.ceil((newX + 50) / TILE_SIZE);
            const startY = Math.floor((newY - 50) / TILE_SIZE);
            const endY = Math.ceil((newY + 50) / TILE_SIZE);

            for (let x = startX; x <= endX; x++) {
                for (let y = startY; y <= endY; y++) {
                    const noise = seededRandom(x, y);
                    if (noise < 0.02) { // É uma árvore
                        const treeX = x * TILE_SIZE + 16;
                        const treeY = y * TILE_SIZE + 16;
                        const dx = newX - treeX;
                        const dy = newY - treeY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < game.player.radius + 8) return true;
                    }
                }
            }
            return false;
        }

        function drawWorld(ctx) {
            const startX = Math.floor(game.camera.x / TILE_SIZE) - 1;
            const endX = Math.ceil((game.camera.x + game.width) / TILE_SIZE) + 1;
            const startY = Math.floor(game.camera.y / TILE_SIZE) - 1;
            const endY = Math.ceil((game.camera.y + game.height) / TILE_SIZE) + 1;

            for (let x = startX; x <= endX; x++) {
                for (let y = startY; y <= endY; y++) {
                    const noise = seededRandom(x, y);
                    const worldX = x * TILE_SIZE;
                    const worldY = y * TILE_SIZE;

                    ctx.fillStyle = noise > 0.8 ? "#559449" : "#5da051";
                    ctx.fillRect(worldX, worldY, TILE_SIZE + 0.5, TILE_SIZE + 0.5);

                    if (noise < 0.02) drawTree(ctx, worldX + 16, worldY + 16);
                    else if (noise > 0.98) drawBush(ctx, worldX + 16, worldY + 16);
                }
            }
        }

        function drawTree(ctx, x, y) {
            ctx.fillStyle = "#4a2d18"; ctx.fillRect(x - 4, y, 8, 12);
            ctx.fillStyle = "#2d5a27"; ctx.fillRect(x - 12, y - 20, 24, 20);
        }

        function drawBush(ctx, x, y) {
            ctx.fillStyle = "#3a7332"; ctx.beginPath(); ctx.arc(x, y + 8, 8, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = "#ff4d4d"; ctx.fillRect(x - 2, y + 6, 4, 4);
        }

        // --- INPUT SYSTEM ---
        const stick = document.getElementById('joystick-stick');
        const base = document.getElementById('joystick-base');

        const handleInput = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = base.getBoundingClientRect();
            const dx = touch.clientX - (rect.left + rect.width / 2);
            const dy = touch.clientY - (rect.top + rect.height / 2);
            const dist = Math.sqrt(dx * dx + dy * dy);
            const max = 40;

            const normalizedDX = dist > max ? dx * max / dist : dx;
            const normalizedDY = dist > max ? dy * max / dist : dy;
            
            stick.style.transform = `translate(${normalizedDX}px, ${normalizedDY}px)`;
            game.input.joyX = normalizedDX / max;
            game.input.joyY = normalizedDY / max;
            if (dx !== 0) game.player.dir = dx > 0 ? 1 : -1;
        };

        base.addEventListener('touchstart', (e) => { game.input.isTouching = true; handleInput(e); }, {passive: false});
        window.addEventListener('touchmove', (e) => { if(game.input.isTouching) handleInput(e); }, {passive: false});
        window.addEventListener('touchend', () => { 
            game.input.isTouching = false; game.input.joyX = 0; game.input.joyY = 0;
            stick.style.transform = `translate(0px, 0px)`;
        });

        // --- ENGINE CORE ---
        function resize() {
            game.width = canvas.width = window.innerWidth;
            game.height = canvas.height = window.innerHeight;
            ctx.imageSmoothingEnabled = false;
        }

        function update(dt) {
            if (game.input.isTouching) {
                const nextX = game.player.x + game.input.joyX * PLAYER_SPEED * dt;
                const nextY = game.player.y + game.input.joyY * PLAYER_SPEED * dt;

                // Colisão Independente nos Eixos (Deslizar em paredes)
                if (!checkCollision(nextX, game.player.y)) game.player.x = nextX;
                if (!checkCollision(game.player.x, nextY)) game.player.y = nextY;
            }

            game.camera.x = game.player.x - game.width / 2;
            game.camera.y = game.player.y - game.height / 2;

            game.player.hunger -= 0.5 * dt;
            document.getElementById('hunger-bar').style.width = Math.max(0, game.player.hunger) + "%";
        }

        function draw() {
            ctx.fillStyle = "#222"; ctx.fillRect(0, 0, game.width, game.height);
            ctx.save();
            ctx.translate(-game.camera.x, -game.camera.y);
            drawWorld(ctx);

            // Jogador
            ctx.fillStyle = "white"; ctx.fillRect(game.player.x - 16, game.player.y - 16, 32, 32);
            ctx.fillStyle = "#fb923c"; ctx.fillRect(game.player.x + (game.player.dir === 1 ? 12 : -24), game.player.y - 4, 12, 8);
            ctx.fillStyle = "black"; ctx.fillRect(game.player.x + (game.player.dir === 1 ? 6 : -10), game.player.y - 10, 4, 4);
            ctx.restore();
        }

        function loop(timestamp) {
            let dt = Math.min(0.1, (timestamp - game.lastTime) / 1000);
            game.lastTime = timestamp;
            update(dt); draw();
            requestAnimationFrame(loop);
        }

        window.addEventListener('resize', resize);
        resize(); requestAnimationFrame(loop);
    </script>
</body>
</html>
